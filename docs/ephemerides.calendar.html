<!DOCTYPE html>

<html>
<head>
  <title>ephemerides.calendar.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="ephemerides.astro.html">
                ephemerides.astro.js
              </a>
            
              
              <a class="source" href="ephemerides.calc.html">
                ephemerides.calc.js
              </a>
            
              
              <a class="source" href="ephemerides.calendar.html">
                ephemerides.calendar.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ephemerides.calendar.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Ephemerides = (<span class="keyword">function</span>(exports){
  <span class="string">"use strict"</span>;

  exports.calendar = exports.calendar || {};
  exports.data = exports.data || {
    bahai: {},
    excelserial1900: {},
    excelserial1904: {},
    french: {},
    gregorian: {},
    gregserial: {},
    hebrew: {},
    indiancivilcalendar: {},
    islamic: {},
    isoday: {},
    isoweek: {},
    juliancalendar: {},
    julianday: {},
    mayancount: {},
    modifiedjulianday: {},
    persian: {},
    persiana: {},
    unixtime: {}
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Aliases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> astro    = exports.astro,
      calendar = exports.calendar,
      data     = exports.data;

  calendar.constants = {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><em>Julian date of Gregorian epoch: 0000-01-01</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    J0000: <span class="number">1721424.5</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><em>Julian date at Unix epoch: 1970-01-01</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    J1970: <span class="number">2440587.5</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><em>Epoch of Modified Julian Date system</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    JMJD: <span class="number">2400000.5</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><em>Epoch (day 1) of Excel 1900 date system (PC)</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    J1900: <span class="number">2415020.5</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><em>Epoch (day 0) of Excel 1904 date system (Mac)</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    J1904: <span class="number">2416480.5</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><em>Convenience</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    NORM_LEAP: [<span class="string">"Normal year"</span>, <span class="string">"Leap year"</span>]
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Return Julian date of given weekday (0 = Sunday)
in the seven days ending on jd.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.weekday_before = <span class="keyword">function</span>(weekday, jd) {
    <span class="keyword">return</span> jd - astro.jwday(jd - weekday);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Determine the Julian date for:</p>
<p><strong>weekday</strong>      Day of week desired, 0 = Sunday
<strong>jd</strong>           Julian date to begin search
<strong>direction</strong>    1 = next weekday, -1 = last weekday
<strong>offset</strong>       Offset from jd to begin search</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.search_weekday = <span class="keyword">function</span>(weekday, jd, direction, offset) {
    <span class="keyword">return</span> <span class="keyword">this</span>.weekday_before(weekday, jd + (direction * offset));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Utility weekday functions, just wrappers for search_weekday</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.nearest_weekday = <span class="keyword">function</span>(weekday, jd) {
    <span class="keyword">return</span> <span class="keyword">this</span>.search_weekday(weekday, jd, <span class="number">1</span>, <span class="number">3</span>);
  }

  calendar.next_weekday = <span class="keyword">function</span>(weekday, jd) {
    <span class="keyword">return</span> <span class="keyword">this</span>.search_weekday(weekday, jd, <span class="number">1</span>, <span class="number">7</span>);
  }

  calendar.next_or_current_weekday = <span class="keyword">function</span>(weekday, jd) {
    <span class="keyword">return</span> <span class="keyword">this</span>.search_weekday(weekday, jd, <span class="number">1</span>, <span class="number">6</span>);
  }

  calendar.previous_weekday = <span class="keyword">function</span>(weekday, jd) {
    <span class="keyword">return</span> <span class="keyword">this</span>.search_weekday(weekday, jd, -<span class="number">1</span>, <span class="number">1</span>);
  }

  calendar.previous_or_current_weekday = <span class="keyword">function</span>(weekday, jd) {
    <span class="keyword">return</span> <span class="keyword">this</span>.search_weekday(weekday, jd, <span class="number">1</span>, <span class="number">0</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Is a given year in the Gregorian calendar a leap year?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.leap_gregorian = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> ((year % <span class="number">4</span>) == <span class="number">0</span>) &amp;&amp;
      (!(((year % <span class="number">100</span>) == <span class="number">0</span>) &amp;&amp; ((year % <span class="number">400</span>) != <span class="number">0</span>)));
  }

  <span class="keyword">var</span> GREGORIAN_EPOCH = <span class="number">1721425.5</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Determine Julian day number from Gregorian calendar date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.gregorian_to_jd = <span class="keyword">function</span>(year, month, day) {
    <span class="keyword">return</span> (GREGORIAN_EPOCH - <span class="number">1</span>) +
      (<span class="number">365</span> * (year - <span class="number">1</span>)) +
      Math.floor((year - <span class="number">1</span>) / <span class="number">4</span>) +
      (-Math.floor((year - <span class="number">1</span>) / <span class="number">100</span>)) +
      Math.floor((year - <span class="number">1</span>) / <span class="number">400</span>) +
      Math.floor((((<span class="number">367</span> * month) - <span class="number">362</span>) / <span class="number">12</span>) +
        ((month &lt;= <span class="number">2</span>) ? <span class="number">0</span> :
          (<span class="keyword">this</span>.leap_gregorian(year) ? -<span class="number">1</span> : -<span class="number">2</span>)
        ) +
        day);
  }

  <span class="keyword">var</span> GREGORIAN_MONTHS = [<span class="string">"January"</span>, <span class="string">"February"</span>, <span class="string">"March"</span>, <span class="string">"April"</span>, <span class="string">"May"</span>, <span class="string">"June"</span>, <span class="string">"July"</span>, <span class="string">"August"</span>, <span class="string">"September"</span>, <span class="string">"October"</span>, <span class="string">"November"</span>, <span class="string">"December"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Calculate Gregorian calendar date from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_gregorian = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> wjd, depoch, quadricent, dqc, cent, dcent, quad, dquad,
      yindex, dyindex, year, yearday, leapadj, month, day;

    wjd        = Math.floor(jd - <span class="number">0.5</span>) + <span class="number">0.5</span>;
    depoch     = wjd - GREGORIAN_EPOCH;
    quadricent = Math.floor(depoch / <span class="number">146097</span>);
    dqc        = astro.mod(depoch, <span class="number">146097</span>);
    cent       = Math.floor(dqc / <span class="number">36524</span>);
    dcent      = astro.mod(dqc, <span class="number">36524</span>);
    quad       = Math.floor(dcent / <span class="number">1461</span>);
    dquad      = astro.mod(dcent, <span class="number">1461</span>);
    yindex     = Math.floor(dquad / <span class="number">365</span>);
    year       = (quadricent * <span class="number">400</span>) + (cent * <span class="number">100</span>) + (quad * <span class="number">4</span>) + yindex;

    <span class="keyword">if</span> (!((cent == <span class="number">4</span>) || (yindex == <span class="number">4</span>))) { year++; }

    yearday = wjd - <span class="keyword">this</span>.gregorian_to_jd(year, <span class="number">1</span>, <span class="number">1</span>);
    leapadj = ((wjd &lt; <span class="keyword">this</span>.gregorian_to_jd(year, <span class="number">3</span>, <span class="number">1</span>)) ? <span class="number">0</span> :
      (<span class="keyword">this</span>.leap_gregorian(year) ? <span class="number">1</span> : <span class="number">2</span>)
    );
    month = Math.floor((((yearday + leapadj) * <span class="number">12</span>) + <span class="number">373</span>) / <span class="number">367</span>);
    day   = (wjd - <span class="keyword">this</span>.gregorian_to_jd(year, month, <span class="number">1</span>)) + <span class="number">1</span>;

    <span class="keyword">return</span> [year, month, day];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return Julian day of given ISO year, week, and day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.n_weeks = <span class="keyword">function</span>(weekday, jd, nthweek) {
    <span class="keyword">var</span> j = <span class="number">7</span> * nthweek;

    <span class="keyword">if</span> (nthweek &gt; <span class="number">0</span>) {
      j += <span class="keyword">this</span>.previous_weekday(weekday, jd);
    } <span class="keyword">else</span> {
      j += <span class="keyword">this</span>.next_weekday(weekday, jd);
    }

    <span class="keyword">return</span> j;
  }

  calendar.iso_to_julian = <span class="keyword">function</span>(year, week, day) {
    <span class="keyword">return</span> day + <span class="keyword">this</span>.n_weeks(<span class="number">0</span>, <span class="keyword">this</span>.gregorian_to_jd(year - <span class="number">1</span>, <span class="number">12</span>, <span class="number">28</span>), week);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Return array of ISO (year, week, day) for Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_iso = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> year, week, day;

    year = <span class="keyword">this</span>.jd_to_gregorian(jd - <span class="number">3</span>)[<span class="number">0</span>];

    <span class="keyword">if</span> (jd &gt;= <span class="keyword">this</span>.iso_to_julian(year + <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)) { year++; }

    week = Math.floor((jd - <span class="keyword">this</span>.iso_to_julian(year, <span class="number">1</span>, <span class="number">1</span>)) / <span class="number">7</span>) + <span class="number">1</span>;
    day  = astro.jwday(jd);

    <span class="keyword">if</span> (day == <span class="number">0</span>) { day = <span class="number">7</span>; }

    <span class="keyword">return</span> [year, week, day];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Return Julian day of given ISO year, and day of year</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.iso_day_to_julian = <span class="keyword">function</span>(year, day) {
    <span class="keyword">return</span> (day - <span class="number">1</span>) + <span class="keyword">this</span>.gregorian_to_jd(year, <span class="number">1</span>, <span class="number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Return array of ISO (year, day_of_year) for Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_iso_day = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> year, day;

    year = <span class="keyword">this</span>.jd_to_gregorian(jd)[<span class="number">0</span>];
    day = Math.floor(jd - <span class="keyword">this</span>.gregorian_to_jd(year, <span class="number">1</span>, <span class="number">1</span>)) + <span class="number">1</span>;
    <span class="keyword">return</span> [year, day];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Pad a string to a given length with a given fill character.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.pad = <span class="keyword">function</span>(str, howlong, padwith) {
    <span class="keyword">var</span> s = str.toString();

    <span class="keyword">while</span> (s.length &lt; howlong) {
      s = padwith + s;
    }

    <span class="keyword">return</span> s;
  }

  <span class="keyword">var</span> JULIAN_EPOCH = <span class="number">1721423.5</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Determine Julian day number from Julian calendar date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.leap_julian = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> astro.mod(year, <span class="number">4</span>) == ((year &gt; <span class="number">0</span>) ? <span class="number">0</span> : <span class="number">3</span>);
  }

  calendar.julian_to_jd = <span class="keyword">function</span>(year, month, day) {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Adjust negative common era years to the zero-based notation we use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (year &lt; <span class="number">1</span>) { year++; }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Algorithm as given in <em>Meeus, <strong>Astronomical Algorithms</strong>, Chapter 7, page 61</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (month &lt;= <span class="number">2</span>) {
      year--;
      month += <span class="number">12</span>;
    }

    <span class="keyword">return</span> ((Math.floor((<span class="number">365.25</span> * (year + <span class="number">4716</span>))) +
      Math.floor((<span class="number">30.6001</span> * (month + <span class="number">1</span>))) +
      day) - <span class="number">1524.5</span>);
  }

  <span class="keyword">var</span> JULIAN_MONTHS = [<span class="string">"January"</span>, <span class="string">"February"</span>, <span class="string">"March"</span>, <span class="string">"April"</span>, <span class="string">"May"</span>, <span class="string">"June"</span>, <span class="string">"July"</span>, <span class="string">"August"</span>, <span class="string">"September"</span>, <span class="string">"October"</span>, <span class="string">"November"</span>, <span class="string">"December"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Calculate Julian calendar date from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_julian = <span class="keyword">function</span>(td) {
    <span class="keyword">var</span> z, a, alpha, b, c, d, e, year, month, day;

    td += <span class="number">0.5</span>;
    z = Math.floor(td);

    a = z;
    b = a + <span class="number">1524</span>;
    c = Math.floor((b - <span class="number">122.1</span>) / <span class="number">365.25</span>);
    d = Math.floor(<span class="number">365.25</span> * c);
    e = Math.floor((b - d) / <span class="number">30.6001</span>);

    month = Math.floor((e &lt; <span class="number">14</span>) ? (e - <span class="number">1</span>) : (e - <span class="number">13</span>));
    year = Math.floor((month &gt; <span class="number">2</span>) ? (c - <span class="number">4716</span>) : (c - <span class="number">4715</span>));
    day = b - d - Math.floor(<span class="number">30.6001</span> * e);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If year is less than 1, subtract one to convert from
a zero based date system to the common era system in
which the year -1 (1 B.C.E) is followed by year 1 (1 C.E.).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (year &lt; <span class="number">1</span>) { year--; }

    <span class="keyword">return</span> [year, month, day];
  }

  <span class="keyword">var</span> HEBREW_EPOCH = <span class="number">347995.5</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Determine Julian day from Hebrew date</p>
<p>Is a given Hebrew year a leap year?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.hebrew_leap = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> astro.mod(((year * <span class="number">7</span>) + <span class="number">1</span>), <span class="number">19</span>) &lt; <span class="number">7</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>How many months are there in a Hebrew year (12 = normal, 13 = leap)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.hebrew_year_months = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> <span class="keyword">this</span>.hebrew_leap(year) ? <span class="number">13</span> : <span class="number">12</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Test for delay of start of new year and to avoid
Sunday, Wednesday, and Friday as start of the new year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.hebrew_delay_1 = <span class="keyword">function</span>(year) {
    <span class="keyword">var</span> months, day, parts;

    months = Math.floor(((<span class="number">235</span> * year) - <span class="number">234</span>) / <span class="number">19</span>);
    parts  = <span class="number">12084</span> + (<span class="number">13753</span> * months);
    day    = (months * <span class="number">29</span>) + Math.floor(parts / <span class="number">25920</span>);

    <span class="keyword">if</span> (astro.mod((<span class="number">3</span> * (day + <span class="number">1</span>)), <span class="number">7</span>) &lt; <span class="number">3</span>) {
      day++;
    }

    <span class="keyword">return</span> day;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Check for delay in start of new year due to length of adjacent years</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.hebrew_delay_2 = <span class="keyword">function</span>(year) {
    <span class="keyword">var</span> last, present, next;

    last    = <span class="keyword">this</span>.hebrew_delay_1(year - <span class="number">1</span>);
    present = <span class="keyword">this</span>.hebrew_delay_1(year);
    next    = <span class="keyword">this</span>.hebrew_delay_1(year + <span class="number">1</span>);

    <span class="keyword">return</span> ((next - present) == <span class="number">356</span>) ? <span class="number">2</span> :
      (((present - last) == <span class="number">382</span>) ? <span class="number">1</span> : <span class="number">0</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>How many days are in a Hebrew year?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.hebrew_year_days = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> <span class="keyword">this</span>.hebrew_to_jd(year + <span class="number">1</span>, <span class="number">7</span>, <span class="number">1</span>) - <span class="keyword">this</span>.hebrew_to_jd(year, <span class="number">7</span>, <span class="number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>How many days are in a given month of a given year</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.hebrew_month_days = <span class="keyword">function</span>(year, month) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>First of all, dispose of fixed-length 29 day months</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (month == <span class="number">2</span> || month == <span class="number">4</span> || month == <span class="number">6</span> ||
      month == <span class="number">10</span> || month == <span class="number">13</span>) {
      <span class="keyword">return</span> <span class="number">29</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>If it&#39;s not a leap year, Adar has 29 days</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (month == <span class="number">12</span> &amp;&amp; !<span class="keyword">this</span>.hebrew_leap(year)) {
      <span class="keyword">return</span> <span class="number">29</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>If it&#39;s Heshvan, days depend on length of year</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (month == <span class="number">8</span> &amp;&amp; !(astro.mod(<span class="keyword">this</span>.hebrew_year_days(year), <span class="number">10</span>) == <span class="number">5</span>)) {
      <span class="keyword">return</span> <span class="number">29</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Similarly, Kislev varies with the length of year</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (month == <span class="number">9</span> &amp;&amp; (astro.mod(<span class="keyword">this</span>.hebrew_year_days(year), <span class="number">10</span>) == <span class="number">3</span>)) {
      <span class="keyword">return</span> <span class="number">29</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Nope, it&#39;s a 30 day month</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="number">30</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Finally, wrap it all up into...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.hebrew_to_jd = <span class="keyword">function</span>(year, month, day) {
    <span class="keyword">var</span> jd, mon, months;

    months = <span class="keyword">this</span>.hebrew_year_months(year);
    jd = HEBREW_EPOCH + <span class="keyword">this</span>.hebrew_delay_1(year) +
      <span class="keyword">this</span>.hebrew_delay_2(year) + day + <span class="number">1</span>;

    <span class="keyword">if</span> (month &lt; <span class="number">7</span>) {
      <span class="keyword">for</span> (mon = <span class="number">7</span>; mon &lt;= months; mon++) {
        jd += <span class="keyword">this</span>.hebrew_month_days(year, mon);
      }
      <span class="keyword">for</span> (mon = <span class="number">1</span>; mon &lt; month; mon++) {
        jd += <span class="keyword">this</span>.hebrew_month_days(year, mon);
      }
    } <span class="keyword">else</span> {
      <span class="keyword">for</span> (mon = <span class="number">7</span>; mon &lt; month; mon++) {
        jd += <span class="keyword">this</span>.hebrew_month_days(year, mon);
      }
    }

    <span class="keyword">return</span> jd;
  }

  <span class="keyword">var</span> HEBREW_MONTHS = [<span class="string">"Nisan"</span>, <span class="string">"Iyyar"</span>, <span class="string">"Sivan"</span>, <span class="string">"Tammuz"</span>, <span class="string">"Av"</span>, <span class="string">"Elul"</span>, <span class="string">"Tishri"</span>, <span class="string">"Marẖeshvan"</span>, <span class="string">"Kislev"</span>, <span class="string">"Teveth"</span>, <span class="string">"Shevat"</span>, <span class="string">"Adar"</span>, <span class="string">"Veadar"</span>],
      HEBREW_WORD_MONTHS = [<span class="string">"נִיסָן"</span>, <span class="string">"אייר"</span>, <span class="string">"סיוון"</span>, <span class="string">"תַּמּוּז"</span>, <span class="string">"אָב"</span>, <span class="string">"אֱלוּל"</span>, <span class="string">"תִּשׁרִי"</span>, <span class="string">"מרחשוון"</span>, <span class="string">"כסליו"</span>, <span class="string">"טֵבֵת"</span>, <span class="string">"שְׁבָט"</span>, <span class="string">"אֲדָר א׳"</span>, <span class="string">"אֲדָר א׳"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Convert Julian date to Hebrew date
This works by making multiple calls to
the inverse function, and is this very
slow.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_hebrew = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> year, month, day, i, count, first;

    jd    = Math.floor(jd) + <span class="number">0.5</span>;
    count = Math.floor(((jd - HEBREW_EPOCH) * <span class="number">98496.0</span>) / <span class="number">35975351.0</span>);
    year  = count - <span class="number">1</span>;

    <span class="keyword">for</span> (i = count; jd &gt;= <span class="keyword">this</span>.hebrew_to_jd(i, <span class="number">7</span>, <span class="number">1</span>); i++) {
      year++;
    }

    first = (jd &lt; <span class="keyword">this</span>.hebrew_to_jd(year, <span class="number">1</span>, <span class="number">1</span>)) ? <span class="number">7</span> : <span class="number">1</span>;
    month = first;

    <span class="keyword">for</span> (i = first; jd &gt; <span class="keyword">this</span>.hebrew_to_jd(year, i, <span class="keyword">this</span>.hebrew_month_days(year, i)); i++) {
      month++;
    }

    day = (jd - <span class="keyword">this</span>.hebrew_to_jd(year, month, <span class="number">1</span>)) + <span class="number">1</span>;

    <span class="keyword">return</span> [year, month, day];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Determine Julian day and fraction of the
September equinox at the Paris meridian in
a given Gregorian year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.equinoxe_a_paris = <span class="keyword">function</span>(year) {
    <span class="keyword">var</span> equJED, equJD, equAPP, equParis, dtParis;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>September equinox in dynamical time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    equJED = astro.equinox(year, <span class="number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Correct for delta T to obtain Universal time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    equJD = equJED - (astro.deltat(year) / (<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Apply the equation of time to yield the apparent time at Greenwich</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    equAPP = equJD + astro.equationOfTime(equJED);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Finally, we must correct for the constant difference between
the Greenwich meridian and that of Paris, 2°20&#39;15&quot; to the
East.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dtParis = (<span class="number">2</span> + (<span class="number">20</span> / <span class="number">60.0</span>) + (<span class="number">15</span> / (<span class="number">60</span> * <span class="number">60.0</span>))) / <span class="number">360</span>;
    equParis = equAPP + dtParis;

    <span class="keyword">return</span> equParis;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Calculate Julian day during which the
September equinox, reckoned from the Paris
meridian, occurred for a given Gregorian
year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.paris_equinoxe_jd = <span class="keyword">function</span>(year) {
    <span class="keyword">var</span> ep, epg;

    ep  = <span class="keyword">this</span>.equinoxe_a_paris(year);
    epg = Math.floor(ep - <span class="number">0.5</span>) + <span class="number">0.5</span>;

    <span class="keyword">return</span> epg;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Determine the year in the French
revolutionary calendar in which a given Julian day falls.
Returns an array of two elements:</p>
<p><strong>[0]</strong> Année de la Révolution
<strong>[1]</strong> Julian day number containing equinox for this year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> FRENCH_REVOLUTIONARY_EPOCH = <span class="number">2375839.5</span>;

  calendar.annee_da_la_revolution = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> guess = <span class="keyword">this</span>.jd_to_gregorian(jd)[<span class="number">0</span>] - <span class="number">2</span>,
      lasteq, nexteq, adr;

    lasteq = <span class="keyword">this</span>.paris_equinoxe_jd(guess);

    <span class="keyword">while</span> (lasteq &gt; jd) {
      guess--;
      lasteq = <span class="keyword">this</span>.paris_equinoxe_jd(guess);
    }

    nexteq = lasteq - <span class="number">1</span>;

    <span class="keyword">while</span> (!((lasteq &lt;= jd) &amp;&amp; (jd &lt; nexteq))) {
      lasteq = nexteq;
      guess++;
      nexteq = <span class="keyword">this</span>.paris_equinoxe_jd(guess);
    }

    adr = Math.round((lasteq - FRENCH_REVOLUTIONARY_EPOCH) / astro.constants.TROPICAL_YEAR) + <span class="number">1</span>;

    <span class="keyword">return</span> [adr, lasteq];
  }

  <span class="keyword">var</span> FRENCH_MOIS = [<span class="string">"Vendémiaire"</span>, <span class="string">"Brumaire"</span>, <span class="string">"Frimaire"</span>, <span class="string">"Nivôse"</span>, <span class="string">"Pluviôse"</span>, <span class="string">"Ventôse"</span>, <span class="string">"Germinal"</span>, <span class="string">"Floréal"</span>, <span class="string">"Prairial"</span>, <span class="string">"Messidor"</span>, <span class="string">"Thermidor"</span>, <span class="string">"Fructidor"</span>, <span class="string">"(Sans-culottides)"</span>],
      FRENCH_DECADE = [<span class="string">"I"</span>, <span class="string">"II"</span>, <span class="string">"III"</span>],
      FRENCH_JOUR = [<span class="string">"du Primidi (1)"</span>, <span class="string">"du Duodi (2)"</span>, <span class="string">"du Tridi (3)"</span>, <span class="string">"du Quartidi (4)"</span>, <span class="string">"du Quintidi (5)"</span>, <span class="string">"du Sextidi (6)"</span>, <span class="string">"du Septidi (7)"</span>, <span class="string">"du Octid (8)i"</span>, <span class="string">"du Nonidi (9)"</span>, <span class="string">"du Décadi (10)"</span>, <span class="string">"------------"</span>, <span class="string">"de la Vertu (1)"</span>, <span class="string">"du Génie (2)"</span>, <span class="string">"du Travail (3)"</span>, <span class="string">"de l'Opinion (4)"</span>, <span class="string">"des Récompenses (5)"</span>, <span class="string">"de la Révolution (6)"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Calculate date in the French Revolutionary
calendar from Julian day. The five or six
&quot;sansculottides&quot; are considered a thirteenth
month in the results of this function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_french_revolutionary = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> an, mois, decade, jour,
      adr, equinoxe;

    jd       = Math.floor(jd) + <span class="number">0.5</span>;
    adr      = <span class="keyword">this</span>.annee_da_la_revolution(jd);
    an       = adr[<span class="number">0</span>];
    equinoxe = adr[<span class="number">1</span>];
    mois     = Math.floor((jd - equinoxe) / <span class="number">30</span>) + <span class="number">1</span>;
    jour     = (jd - equinoxe) % <span class="number">30</span>;
    decade   = Math.floor(jour / <span class="number">10</span>) + <span class="number">1</span>;
    jour     = (jour % <span class="number">10</span>) + <span class="number">1</span>;

    <span class="keyword">return</span> [an, mois, decade, jour];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Obtain Julian day from a given French
Revolutionary calendar date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.french_revolutionary_to_jd = <span class="keyword">function</span>(an, mois, decade, jour) {
    <span class="keyword">var</span> adr, equinoxe, guess, jd;

    guess = FRENCH_REVOLUTIONARY_EPOCH + (astro.constants.TROPICAL_YEAR * ((an - <span class="number">1</span>) - <span class="number">1</span>));
    adr = [an - <span class="number">1</span>, <span class="number">0</span>];

    <span class="keyword">while</span> (adr[<span class="number">0</span>] &lt; an) {
      adr = <span class="keyword">this</span>.annee_da_la_revolution(guess);
      guess = adr[<span class="number">1</span>] + (astro.constants.TROPICAL_YEAR + <span class="number">2</span>);
    }
    equinoxe = adr[<span class="number">1</span>];

    jd = equinoxe + (<span class="number">30</span> * (mois - <span class="number">1</span>)) + (<span class="number">10</span> * (decade - <span class="number">1</span>)) + (jour - <span class="number">1</span>);
    <span class="keyword">return</span> jd;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Is a given year a leap year in the Islamic calendar?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.leap_islamic = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> (((year * <span class="number">11</span>) + <span class="number">14</span>) % <span class="number">30</span>) &lt; <span class="number">11</span>;
  }

  <span class="keyword">var</span> ISLAMIC_EPOCH    = <span class="number">1948439.5</span>,
      ISLAMIC_WEEKDAYS = [<span class="string">"al-'ahad"</span>, <span class="string">"al-'ithnayn"</span>, <span class="string">"ath-thalatha'"</span>, <span class="string">"al-'arb`a'"</span>, <span class="string">"al-khamis"</span>, <span class="string">"al-jum`a"</span>, <span class="string">"as-sabt"</span>],
      ISLAMIC_MONTHS   = [<span class="string">"Muharram"</span>, <span class="string">"Safar"</span>, <span class="string">"Rabi`al-Awwal"</span>, <span class="string">"Rabi`ath-Thani"</span>, <span class="string">"Jumada l-Ula"</span>, <span class="string">"Jumada t-Tania"</span>, <span class="string">"Rajab"</span>, <span class="string">"Sha`ban"</span>, <span class="string">"Ramadan"</span>, <span class="string">"Shawwal"</span>, <span class="string">"Dhu l-Qa`da"</span>, <span class="string">"Dhu l-Hijja"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Determine Julian day from Islamic date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.islamic_to_jd = <span class="keyword">function</span>(year, month, day) {
    <span class="keyword">return</span> (day +
      Math.ceil(<span class="number">29.5</span> * (month - <span class="number">1</span>)) +
      (year - <span class="number">1</span>) * <span class="number">354</span> +
      Math.floor((<span class="number">3</span> + (<span class="number">11</span> * year)) / <span class="number">30</span>) +
      ISLAMIC_EPOCH) - <span class="number">1</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Calculate Islamic date from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_islamic = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> year, month, day;

    jd    = Math.floor(jd) + <span class="number">0.5</span>;
    year  = Math.floor(((<span class="number">30</span> * (jd - ISLAMIC_EPOCH)) + <span class="number">10646</span>) / <span class="number">10631</span>);
    month = Math.min(<span class="number">12</span>, Math.ceil((jd - (<span class="number">29</span> + <span class="keyword">this</span>.islamic_to_jd(year, <span class="number">1</span>, <span class="number">1</span>))) / <span class="number">29.5</span>) + <span class="number">1</span>);
    day   = (jd - <span class="keyword">this</span>.islamic_to_jd(year, month, <span class="number">1</span>)) + <span class="number">1</span>;

    <span class="keyword">return</span> [year, month, day];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Determine Julian day and fraction of the
March equinox at the Tehran meridian in
a given Gregorian year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.tehran_equinox = <span class="keyword">function</span>(year) {
    <span class="keyword">var</span> equJED, equJD, equAPP, equTehran, dtTehran;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>March equinox in dynamical time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    equJED = astro.equinox(year, <span class="number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Correct for delta T to obtain Universal time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    equJD = equJED - (astro.deltat(year) / (<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Apply the equation of time to yield the apparent time at Greenwich</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    equAPP = equJD + astro.equationOfTime(equJED);</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Finally, we must correct for the constant difference between
the Greenwich meridian andthe time zone standard for
Iran Standard time, 52°30&#39; to the East.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dtTehran  = (<span class="number">52</span> + (<span class="number">30</span> / <span class="number">60.0</span>) + (<span class="number">0</span> / (<span class="number">60.0</span> * <span class="number">60.0</span>))) / <span class="number">360</span>;
    equTehran = equAPP + dtTehran;

    <span class="keyword">return</span> equTehran;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Calculate Julian day during which the
March equinox, reckoned from the Tehran
meridian, occurred for a given Gregorian
year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.tehran_equinox_jd = <span class="keyword">function</span>(year) {
    <span class="keyword">var</span> ep, epg;

    ep  = <span class="keyword">this</span>.tehran_equinox(year);
    epg = Math.floor(ep);

    <span class="keyword">return</span> epg;
  }

  <span class="keyword">var</span> PERSIAN_EPOCH    = <span class="number">1948320.5</span>,
      PERSIAN_WEEKDAYS = [<span class="string">"Yekshanbeh"</span>, <span class="string">"Doshanbeh"</span>, <span class="string">"Seshhanbeh"</span>, <span class="string">"Chaharshanbeh"</span>, <span class="string">"Panjshanbeh"</span>, <span class="string">"Jomeh"</span>, <span class="string">"Shanbeh"</span>],
      PERSIAN_MONTHS   = [<span class="string">"Farvardin"</span>, <span class="string">"Ordibehesht"</span>, <span class="string">"Khordad"</span>, <span class="string">"Tir"</span>, <span class="string">"Mordad"</span>, <span class="string">"Shahrivar"</span>, <span class="string">"Mehr"</span>, <span class="string">"Aban"</span>, <span class="string">"Azar"</span>, <span class="string">"Dey"</span>, <span class="string">"Bahman"</span>, <span class="string">"Esfand"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Determine the year in the Persian
astronomical calendar in which a
given Julian day falls. Returns an
array of two elements:</p>
<p><strong>[0]</strong> Persian year
<strong>[1]</strong> Julian day number containing equinox for this year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.persiana_year = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> guess = <span class="keyword">this</span>.jd_to_gregorian(jd)[<span class="number">0</span>] - <span class="number">2</span>,
      lasteq, nexteq, adr;

    lasteq = <span class="keyword">this</span>.tehran_equinox_jd(guess);

    <span class="keyword">while</span> (lasteq &gt; jd) {
      guess--;
      lasteq = <span class="keyword">this</span>.tehran_equinox_jd(guess);
    }

    nexteq = lasteq - <span class="number">1</span>;

    <span class="keyword">while</span> (!((lasteq &lt;= jd) &amp;&amp; (jd &lt; nexteq))) {
      lasteq = nexteq;
      guess++;
      nexteq = <span class="keyword">this</span>.tehran_equinox_jd(guess);
    }

    adr = Math.round((lasteq - PERSIAN_EPOCH) / astro.constants.TROPICAL_YEAR) + <span class="number">1</span>;

    <span class="keyword">return</span> [adr, lasteq];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Calculate date in the Persian astronomical
calendar from Julian day.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_persiana = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> year, month, day, adr, equinox, yday;

    jd      = Math.floor(jd) + <span class="number">0.5</span>;
    adr     = <span class="keyword">this</span>.persiana_year(jd);
    year    = adr[<span class="number">0</span>];
    equinox = adr[<span class="number">1</span>];
    day     = Math.floor((jd - equinox) / <span class="number">30</span>) + <span class="number">1</span>;

    yday  = (Math.floor(jd) - <span class="keyword">this</span>.persiana_to_jd(year, <span class="number">1</span>, <span class="number">1</span>)) + <span class="number">1</span>;
    month = (yday &lt;= <span class="number">186</span>) ? Math.ceil(yday / <span class="number">31</span>) : Math.ceil((yday - <span class="number">6</span>) / <span class="number">30</span>);
    day   = (Math.floor(jd) - <span class="keyword">this</span>.persiana_to_jd(year, month, <span class="number">1</span>)) + <span class="number">1</span>;

    <span class="keyword">return</span> [year, month, day];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Obtain Julian day from a given Persian
astronomical calendar date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.persiana_to_jd = <span class="keyword">function</span>(year, month, day) {
    <span class="keyword">var</span> adr, equinox, guess, jd;

    guess = (PERSIAN_EPOCH - <span class="number">1</span>) + (astro.constants.TROPICAL_YEAR * ((year - <span class="number">1</span>) - <span class="number">1</span>));
    adr   = [year - <span class="number">1</span>, <span class="number">0</span>];

    <span class="keyword">while</span> (adr[<span class="number">0</span>] &lt; year) {
      adr   = <span class="keyword">this</span>.persiana_year(guess);
      guess = adr[<span class="number">1</span>] + (astro.constants.TROPICAL_YEAR + <span class="number">2</span>);
    }

    equinox = adr[<span class="number">1</span>];

    jd = equinox +
      ((month &lt;= <span class="number">7</span>) ?
      ((month - <span class="number">1</span>) * <span class="number">31</span>) :
      (((month - <span class="number">1</span>) * <span class="number">30</span>) + <span class="number">6</span>)
    ) +
      (day - <span class="number">1</span>);

    <span class="keyword">return</span> jd;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Is a given year a leap year in the Persian
astronomical calendar?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.leap_persiana = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> (<span class="keyword">this</span>.persiana_to_jd(year + <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>) -
      <span class="keyword">this</span>.persiana_to_jd(year, <span class="number">1</span>, <span class="number">1</span>)) &gt; <span class="number">365</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Is a given year a leap year in the Persian calendar?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.leap_persian = <span class="keyword">function</span>(year) {
    <span class="keyword">return</span> ((((((year - ((year &gt; <span class="number">0</span>) ? <span class="number">474</span> : <span class="number">473</span>)) % <span class="number">2820</span>) + <span class="number">474</span>) + <span class="number">38</span>) * <span class="number">682</span>) % <span class="number">2816</span>) &lt; <span class="number">682</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Determine Julian day from Persian date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.persian_to_jd = <span class="keyword">function</span>(year, month, day) {
    <span class="keyword">var</span> epbase, epyear;

    epbase = year - ((year &gt;= <span class="number">0</span>) ? <span class="number">474</span> : <span class="number">473</span>);
    epyear = <span class="number">474</span> + astro.mod(epbase, <span class="number">2820</span>);

    <span class="keyword">return</span> day +
      ((month &lt;= <span class="number">7</span>) ?
      ((month - <span class="number">1</span>) * <span class="number">31</span>) :
      (((month - <span class="number">1</span>) * <span class="number">30</span>) + <span class="number">6</span>)
    ) +
      Math.floor(((epyear * <span class="number">682</span>) - <span class="number">110</span>) / <span class="number">2816</span>) +
      (epyear - <span class="number">1</span>) * <span class="number">365</span> +
      Math.floor(epbase / <span class="number">2820</span>) * <span class="number">1029983</span> +
      (PERSIAN_EPOCH - <span class="number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Calculate Persian date from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_persian = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> year, month, day, depoch, cycle, cyear, ycycle,
      aux1, aux2, yday;

    jd = Math.floor(jd) + <span class="number">0.5</span>;

    depoch = jd - <span class="keyword">this</span>.persian_to_jd(<span class="number">475</span>, <span class="number">1</span>, <span class="number">1</span>);
    cycle  = Math.floor(depoch / <span class="number">1029983</span>);
    cyear  = astro.mod(depoch, <span class="number">1029983</span>);

    <span class="keyword">if</span> (cyear == <span class="number">1029982</span>) {
      ycycle = <span class="number">2820</span>;
    } <span class="keyword">else</span> {
      aux1 = Math.floor(cyear / <span class="number">366</span>);
      aux2 = astro.mod(cyear, <span class="number">366</span>);
      ycycle = Math.floor(((<span class="number">2134</span> * aux1) + (<span class="number">2816</span> * aux2) + <span class="number">2815</span>) / <span class="number">1028522</span>) +
        aux1 + <span class="number">1</span>;
    }

    year = ycycle + (<span class="number">2820</span> * cycle) + <span class="number">474</span>;

    <span class="keyword">if</span> (year &lt;= <span class="number">0</span>) { year--; }

    yday  = (jd - <span class="keyword">this</span>.persian_to_jd(year, <span class="number">1</span>, <span class="number">1</span>)) + <span class="number">1</span>;
    month = (yday &lt;= <span class="number">186</span>) ? Math.ceil(yday / <span class="number">31</span>) : Math.ceil((yday - <span class="number">6</span>) / <span class="number">30</span>);
    day   = (jd - <span class="keyword">this</span>.persian_to_jd(year, month, <span class="number">1</span>)) + <span class="number">1</span>;

    <span class="keyword">return</span> [year, month, day];
  }

  <span class="keyword">var</span> MAYAN_COUNT_EPOCH = <span class="number">584282.5</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Determine Julian day from Mayan long count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.mayan_count_to_jd = <span class="keyword">function</span>(baktun, katun, tun, uinal, kin) {
    <span class="keyword">return</span> MAYAN_COUNT_EPOCH +
      (baktun * <span class="number">144000</span>) +
      (katun * <span class="number">7200</span>) +
      (tun * <span class="number">360</span>) +
      (uinal * <span class="number">20</span>) +
      kin;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Calculate Mayan long count from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_mayan_count = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> d, baktun, katun, tun, uinal, kin;

    jd     = Math.floor(jd) + <span class="number">0.5</span>;
    d      = jd - MAYAN_COUNT_EPOCH;
    baktun = Math.floor(d / <span class="number">144000</span>);
    d      = astro.mod(d, <span class="number">144000</span>);
    katun  = Math.floor(d / <span class="number">7200</span>);
    d      = astro.mod(d, <span class="number">7200</span>);
    tun    = Math.floor(d / <span class="number">360</span>);
    d      = astro.mod(d, <span class="number">360</span>);
    uinal  = Math.floor(d / <span class="number">20</span>);
    kin    = astro.mod(d, <span class="number">20</span>);

    <span class="keyword">return</span> [baktun, katun, tun, uinal, kin];
  }

  <span class="keyword">var</span> MAYAN_HAAB_MONTHS = [
    <span class="string">"Pop"</span>, <span class="string">"Uo"</span>, <span class="string">"Zip"</span>, <span class="string">"Zotz"</span>, <span class="string">"Tzec"</span>, <span class="string">"Xul"</span>,
    <span class="string">"Yaxkin"</span>, <span class="string">"Mol"</span>, <span class="string">"Chen"</span>, <span class="string">"Yax"</span>, <span class="string">"Zac"</span>, <span class="string">"Ceh"</span>,
    <span class="string">"Mac"</span>, <span class="string">"Kankin"</span>, <span class="string">"Muan"</span>, <span class="string">"Pax"</span>, <span class="string">"Kayab"</span>, <span class="string">"Cumku"</span>, <span class="string">"Uayeb"</span>
  ];</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Determine Mayan Haab &quot;month&quot; and day from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_mayan_haab = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> lcount, day;

    jd     = Math.floor(jd) + <span class="number">0.5</span>;
    lcount = jd - MAYAN_COUNT_EPOCH;
    day    = astro.mod(lcount + <span class="number">8</span> + ((<span class="number">18</span> - <span class="number">1</span>) * <span class="number">20</span>), <span class="number">365</span>);

    <span class="keyword">return</span> [Math.floor(day / <span class="number">20</span>) + <span class="number">1</span>, astro.mod(day, <span class="number">20</span>)];
  }

  <span class="keyword">var</span> MAYAN_TZOLKIN_MONTHS = [
    <span class="string">"Imix"</span>, <span class="string">"Ik"</span>, <span class="string">"Akbal"</span>, <span class="string">"Kan"</span>, <span class="string">"Chicchan"</span>,
    <span class="string">"Cimi"</span>, <span class="string">"Manik"</span>, <span class="string">"Lamat"</span>, <span class="string">"Muluc"</span>, <span class="string">"Oc"</span>,
    <span class="string">"Chuen"</span>, <span class="string">"Eb"</span>, <span class="string">"Ben"</span>, <span class="string">"Ix"</span>, <span class="string">"Men"</span>,
    <span class="string">"Cib"</span>, <span class="string">"Caban"</span>, <span class="string">"Etznab"</span>, <span class="string">"Cauac"</span>, <span class="string">"Ahau"</span>
  ];</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Determine Mayan Tzolkin &quot;month&quot; and day from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_mayan_tzolkin = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> lcount;

    jd     = Math.floor(jd) + <span class="number">0.5</span>;
    lcount = jd - MAYAN_COUNT_EPOCH;

    <span class="keyword">return</span> [astro.amod(lcount + <span class="number">20</span>, <span class="number">20</span>), astro.amod(lcount + <span class="number">4</span>, <span class="number">13</span>)];
  }

  <span class="keyword">var</span> BAHAI_EPOCH    = <span class="number">2394646.5</span>,
      BAHAI_WEEKDAYS = [<span class="string">"Jamál"</span>, <span class="string">"Kamál"</span>, <span class="string">"Fidál"</span>, <span class="string">"Idál"</span>, <span class="string">"Istijlál"</span>, <span class="string">"Istiqlál"</span>, <span class="string">"Jalál"</span>],
      BAHAI_YEARS    = [<span class="string">"Alif"</span>, <span class="string">"Bá"</span>, <span class="string">"Ab"</span>, <span class="string">"Dál"</span>, <span class="string">"Báb"</span>, <span class="string">"Váv"</span>, <span class="string">"Abad"</span>, <span class="string">"Jád"</span>, <span class="string">"Bahá"</span>, <span class="string">"Hubb"</span>, <span class="string">"Bahháj"</span>, <span class="string">"Javáb"</span>, <span class="string">"Ahad"</span>, <span class="string">"Vahháb"</span>, <span class="string">"Vidád"</span>, <span class="string">"Badí"</span>, <span class="string">"Bahí"</span>, <span class="string">"Abhá"</span>, <span class="string">"Vahíd"</span>],
      BAHAI_MONTHS   = [<span class="string">"Bahá"</span>, <span class="string">"Jalál"</span>, <span class="string">"Jamál"</span>, <span class="string">"`Azamat"</span>, <span class="string">"Núr"</span>, <span class="string">"Rahmat"</span>, <span class="string">"Kalimát"</span>, <span class="string">"Kamál"</span>, <span class="string">"Asmá"</span>, <span class="string">"`Izzat"</span>, <span class="string">"Mashíyyat"</span>, <span class="string">"`Ilm"</span>, <span class="string">"Qudrat"</span>, <span class="string">"Qawl"</span>, <span class="string">"Masáil"</span>, <span class="string">"Sharaf"</span>, <span class="string">"Sultán"</span>, <span class="string">"Mulk"</span>, <span class="string">"Ayyám-i-Há"</span>, <span class="string">"`Alá'"</span>],
      BAHAI_DAYS     = [<span class="string">"Bahá"</span>, <span class="string">"Jalál"</span>, <span class="string">"Jamál"</span>, <span class="string">"`Azamat"</span>, <span class="string">"Núr"</span>, <span class="string">"Rahmat"</span>, <span class="string">"Kalimát"</span>, <span class="string">"Kamál"</span>, <span class="string">"Asmá"</span>, <span class="string">"`Izzat"</span>, <span class="string">"Mashíyyat"</span>, <span class="string">"`Ilm"</span>, <span class="string">"Qudrat"</span>, <span class="string">"Qawl"</span>, <span class="string">"Masáil"</span>, <span class="string">"Sharaf"</span>, <span class="string">"Sultán"</span>, <span class="string">"Mulk"</span>, <span class="string">"`Alá'"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Determine Julian day from Bahai date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.bahai_to_jd = <span class="keyword">function</span>(major, cycle, year, month, day) {
    <span class="keyword">var</span> gy;

    gy = (<span class="number">361</span> * (major - <span class="number">1</span>)) + (<span class="number">19</span> * (cycle - <span class="number">1</span>)) + (year - <span class="number">1</span>) +
      <span class="keyword">this</span>.jd_to_gregorian(BAHAI_EPOCH)[<span class="number">0</span>];
    <span class="keyword">return</span> <span class="keyword">this</span>.gregorian_to_jd(gy, <span class="number">3</span>, <span class="number">20</span>) + (<span class="number">19</span> * (month - <span class="number">1</span>)) +
      ((month != <span class="number">20</span>) ? <span class="number">0</span> : (<span class="keyword">this</span>.leap_gregorian(gy + <span class="number">1</span>) ? -<span class="number">14</span> : -<span class="number">15</span>)) +
      day;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Calculate Bahai date from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_bahai = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> major, cycle, year, month, day,
      gy, bstarty, bys, days, bld;

    jd      = Math.floor(jd) + <span class="number">0.5</span>;
    gy      = <span class="keyword">this</span>.jd_to_gregorian(jd)[<span class="number">0</span>];
    bstarty = <span class="keyword">this</span>.jd_to_gregorian(BAHAI_EPOCH)[<span class="number">0</span>];
    bys     = gy - (bstarty + (((<span class="keyword">this</span>.gregorian_to_jd(gy, <span class="number">1</span>, <span class="number">1</span>) &lt;= jd) &amp;&amp; (jd &lt;= <span class="keyword">this</span>.gregorian_to_jd(gy, <span class="number">3</span>, <span class="number">20</span>))) ? <span class="number">1</span> : <span class="number">0</span>));
    major   = Math.floor(bys / <span class="number">361</span>) + <span class="number">1</span>;
    cycle   = Math.floor(astro.mod(bys, <span class="number">361</span>) / <span class="number">19</span>) + <span class="number">1</span>;
    year    = astro.mod(bys, <span class="number">19</span>) + <span class="number">1</span>;
    days    = jd - <span class="keyword">this</span>.bahai_to_jd(major, cycle, year, <span class="number">1</span>, <span class="number">1</span>);
    bld     = <span class="keyword">this</span>.bahai_to_jd(major, cycle, year, <span class="number">20</span>, <span class="number">1</span>);
    month   = (jd &gt;= bld) ? <span class="number">20</span> : (Math.floor(days / <span class="number">19</span>) + <span class="number">1</span>);
    day     = (jd + <span class="number">1</span>) - <span class="keyword">this</span>.bahai_to_jd(major, cycle, year, month, <span class="number">1</span>);

    <span class="keyword">return</span> [major, cycle, year, month, day];
  }

  <span class="keyword">var</span> INDIAN_CIVIL_WEEKDAYS = [<span class="string">"ravivara"</span>, <span class="string">"somavara"</span>, <span class="string">"mangalavara"</span>, <span class="string">"budhavara"</span>, <span class="string">"brahaspativara"</span>, <span class="string">"sukravara"</span>, <span class="string">"sanivara"</span>],
      INDIAN_CIVIL_MONTHS = [<span class="string">"Caitra"</span>, <span class="string">"Vaisakha"</span>, <span class="string">"Jyaistha"</span>, <span class="string">"Asadha"</span>, <span class="string">"Sravana"</span>, <span class="string">"Bhadra"</span>, <span class="string">"Asvina"</span>, <span class="string">"Kartika"</span>, <span class="string">"Agrahayana"</span>, <span class="string">"Pausa"</span>, <span class="string">"Magha"</span>, <span class="string">"Phalguna"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Obtain Julian day for Indian Civil date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.indian_civil_to_jd = <span class="keyword">function</span>(year, month, day) {
    <span class="keyword">var</span> Caitra, gyear, leap, start, jd, m;

    gyear  = year + <span class="number">78</span>;
    leap   = <span class="keyword">this</span>.leap_gregorian(gyear); <span class="comment">// Is this a leap year ?</span>
    start  = <span class="keyword">this</span>.gregorian_to_jd(gyear, <span class="number">3</span>, leap ? <span class="number">21</span> : <span class="number">22</span>);
    Caitra = leap ? <span class="number">31</span> : <span class="number">30</span>;

    <span class="keyword">if</span> (month == <span class="number">1</span>) {
      jd = start + (day - <span class="number">1</span>);
    } <span class="keyword">else</span> {
      jd = start + Caitra;
      m = month - <span class="number">2</span>;
      m = Math.min(m, <span class="number">5</span>);
      jd += m * <span class="number">31</span>;

      <span class="keyword">if</span> (month &gt;= <span class="number">8</span>) {
        m = month - <span class="number">7</span>;
        jd += m * <span class="number">30</span>;
      }

      jd += day - <span class="number">1</span>;
    }

    <span class="keyword">return</span> jd;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Calculate Indian Civil date from Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.jd_to_indian_civil = <span class="keyword">function</span>(jd) {
    <span class="keyword">var</span> Caitra, Saka, greg, greg0, leap, start, year, month, day, yday, mday;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Offset in years from Saka era to Gregorian epoch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Saka  = <span class="number">79</span> - <span class="number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Day offset between Saka and Gregorian</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    start = <span class="number">80</span>;

    jd     = Math.floor(jd) + <span class="number">0.5</span>;
    greg   = <span class="keyword">this</span>.jd_to_gregorian(jd); <span class="comment">// Gregorian date for Julian day</span>
    leap   = <span class="keyword">this</span>.leap_gregorian(greg[<span class="number">0</span>]); <span class="comment">// Is this a leap year?</span>
    year   = greg[<span class="number">0</span>] - Saka; <span class="comment">// Tentative year in Saka era</span>
    greg0  = <span class="keyword">this</span>.gregorian_to_jd(greg[<span class="number">0</span>], <span class="number">1</span>, <span class="number">1</span>); <span class="comment">// JD at start of Gregorian year</span>
    yday   = jd - greg0; <span class="comment">// Day number (0 based) in Gregorian year</span>
    Caitra = leap ? <span class="number">31</span> : <span class="number">30</span>; <span class="comment">// Days in Caitra this year</span>

    <span class="keyword">if</span> (yday &lt; start) {</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Day is at the end of the preceding Saka year</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      year--;
      yday += Caitra + (<span class="number">31</span> * <span class="number">5</span>) + (<span class="number">30</span> * <span class="number">3</span>) + <span class="number">10</span> + start;
    }

    yday -= start;
    <span class="keyword">if</span> (yday &lt; Caitra) {
      month = <span class="number">1</span>;
      day = yday + <span class="number">1</span>;
    } <span class="keyword">else</span> {
      mday = yday - Caitra;
      <span class="keyword">if</span> (mday &lt; (<span class="number">31</span> * <span class="number">5</span>)) {
        month = Math.floor(mday / <span class="number">31</span>) + <span class="number">2</span>;
        day = (mday % <span class="number">31</span>) + <span class="number">1</span>;
      } <span class="keyword">else</span> {
        mday -= <span class="number">31</span> * <span class="number">5</span>;
        month = Math.floor(mday / <span class="number">30</span>) + <span class="number">7</span>;
        day = (mday % <span class="number">30</span>) + <span class="number">1</span>;
      }
    }

    <span class="keyword">return</span> [year, month, day];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Update all calendars from Gregorian.
<em>&quot;Why not Julian date?&quot;</em> you ask. Because
starting from Gregorian guarantees we&#39;re
already snapped to an integral second, so
we don&#39;t get roundoff errors in other
calendars.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.updateFromGregorian = <span class="keyword">function</span>() {
    <span class="keyword">var</span> j, year, mon, mday, hour, min, sec,
      weekday, julcal, perscal, hebcal, islcal, utime, isoweek,
      may_countcal, mayhaabcal, maytzolkincal, bahcal, frrcal,
      indcal, isoday, xgregcal;

    year = <span class="keyword">new</span> Number(data.gregorian.year);
    mon  = data.gregorian.month;
    mday = <span class="keyword">new</span> Number(data.gregorian.day);
    hour = min = sec = <span class="number">0</span>;
    hour = <span class="keyword">new</span> Number(data.gregorian.hour);
    min  = <span class="keyword">new</span> Number(data.gregorian.min);
    sec  = <span class="keyword">new</span> Number(data.gregorian.sec);</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Update Julian day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    j = <span class="keyword">this</span>.gregorian_to_jd(year, mon + <span class="number">1</span>, mday) +
      (Math.floor(sec + <span class="number">60</span> * (min + <span class="number">60</span> * hour) + <span class="number">0.5</span>) / <span class="number">86400.0</span>);

    data.julianday.day = j;
    data.modifiedjulianday.day = j - <span class="keyword">this</span>.constants.JMJD;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Update day of week in Gregorian box</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    weekday = astro.jwday(j);
    data.gregorian.wday = astro.constants.WEEKDAYS[weekday];</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Update leap year status in Gregorian box</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    data.gregorian.leap = <span class="keyword">this</span>.constants.NORM_LEAP[<span class="keyword">this</span>.leap_gregorian(year) ? <span class="number">1</span> : <span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Update Julian Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    julcal = <span class="keyword">this</span>.jd_to_julian(j);

    data.juliancalendar.year  = julcal[<span class="number">0</span>];
    data.juliancalendar.month = JULIAN_MONTHS[julcal[<span class="number">1</span>] - <span class="number">1</span>];
    data.juliancalendar.day   = julcal[<span class="number">2</span>];
    data.juliancalendar.leap  = <span class="keyword">this</span>.constants.NORM_LEAP[<span class="keyword">this</span>.leap_julian(julcal[<span class="number">0</span>]) ? <span class="number">1</span> : <span class="number">0</span>];
    weekday                   = astro.jwday(j);
    data.juliancalendar.wday  = astro.constants.WEEKDAYS[weekday];</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Update Hebrew Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hebcal = <span class="keyword">this</span>.jd_to_hebrew(j);

    data.hebrew.year     = hebcal[<span class="number">0</span>];
    data.hebrew.month    = HEBREW_MONTHS[hebcal[<span class="number">1</span>] - <span class="number">1</span>];
    data.hebrew.day      = hebcal[<span class="number">2</span>];
    data.hebrew.hebmonth = HEBREW_WORD_MONTHS[hebcal[<span class="number">1</span>] - <span class="number">1</span>];

    <span class="keyword">switch</span> (<span class="keyword">this</span>.hebrew_year_days(hebcal[<span class="number">0</span>])) {
    <span class="keyword">case</span> <span class="number">353</span>:
      data.hebrew.leap = <span class="string">"Common deficient (353 days)"</span>;
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">354</span>:
      data.hebrew.leap = <span class="string">"Common regular (354 days)"</span>;
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">355</span>:
      data.hebrew.leap = <span class="string">"Common complete (355 days)"</span>;
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">383</span>:
      data.hebrew.leap = <span class="string">"Embolismic deficient (383 days)"</span>;
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">384</span>:
      data.hebrew.leap = <span class="string">"Embolismic regular (384 days)"</span>;
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number">385</span>:
      data.hebrew.leap = <span class="string">"Embolismic complete (385 days)"</span>;
      <span class="keyword">break</span>;

    <span class="keyword">default</span>:
      data.hebrew.leap = <span class="string">"Invalid year length: "</span> +
        <span class="keyword">this</span>.hebrew_year_days(hebcal[<span class="number">0</span>]) + <span class="string">" days."</span>;
      <span class="keyword">break</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Update Islamic Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    islcal = <span class="keyword">this</span>.jd_to_islamic(j);

    data.islamic.year  = islcal[<span class="number">0</span>];
    data.islamic.month = ISLAMIC_MONTHS[islcal[<span class="number">1</span>] - <span class="number">1</span>];
    data.islamic.day   = islcal[<span class="number">2</span>];
    data.islamic.wday  = <span class="string">"yawm "</span> + ISLAMIC_WEEKDAYS[weekday];
    data.islamic.leap  = <span class="keyword">this</span>.constants.NORM_LEAP[<span class="keyword">this</span>.leap_islamic(islcal[<span class="number">0</span>]) ? <span class="number">1</span> : <span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Update Persian Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    perscal = <span class="keyword">this</span>.jd_to_persian(j);

    data.persian.year  = perscal[<span class="number">0</span>];
    data.persian.month = PERSIAN_MONTHS[perscal[<span class="number">1</span>] - <span class="number">1</span>];
    data.persian.day   = perscal[<span class="number">2</span>];
    data.persian.wday  = PERSIAN_WEEKDAYS[weekday];
    data.persian.leap  = <span class="keyword">this</span>.constants.NORM_LEAP[<span class="keyword">this</span>.leap_persian(perscal[<span class="number">0</span>]) ? <span class="number">1</span> : <span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Update Persian Astronomical Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    perscal = <span class="keyword">this</span>.jd_to_persiana(j);

    data.persiana.year  = perscal[<span class="number">0</span>];
    data.persiana.month = PERSIAN_MONTHS[perscal[<span class="number">1</span>] - <span class="number">1</span>];
    data.persiana.day   = perscal[<span class="number">2</span>];
    data.persiana.wday  = PERSIAN_WEEKDAYS[weekday];
    data.persiana.leap  = <span class="keyword">this</span>.constants.NORM_LEAP[<span class="keyword">this</span>.leap_persiana(perscal[<span class="number">0</span>]) ? <span class="number">1</span> : <span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Update Mayan Calendars</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    may_countcal = <span class="keyword">this</span>.jd_to_mayan_count(j);

    data.mayancount.baktun  = may_countcal[<span class="number">0</span>];
    data.mayancount.katun   = may_countcal[<span class="number">1</span>];
    data.mayancount.tun     = may_countcal[<span class="number">2</span>];
    data.mayancount.uinal   = may_countcal[<span class="number">3</span>];
    data.mayancount.kin     = may_countcal[<span class="number">4</span>];
    mayhaabcal              = <span class="keyword">this</span>.jd_to_mayan_haab(j);
    data.mayancount.haab    = <span class="string">""</span> + mayhaabcal[<span class="number">1</span>] + <span class="string">" "</span> + MAYAN_HAAB_MONTHS[mayhaabcal[<span class="number">0</span>] - <span class="number">1</span>];
    maytzolkincal           = <span class="keyword">this</span>.jd_to_mayan_tzolkin(j);
    data.mayancount.tzolkin = <span class="string">""</span> + maytzolkincal[<span class="number">1</span>] + <span class="string">" "</span> + MAYAN_TZOLKIN_MONTHS[maytzolkincal[<span class="number">0</span>] - <span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Update Bahai Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bahcal = <span class="keyword">this</span>.jd_to_bahai(j);

    data.bahai.kull_i_shay = bahcal[<span class="number">0</span>];
    data.bahai.vahid       = bahcal[<span class="number">1</span>];
    data.bahai.year        = BAHAI_YEARS[bahcal[<span class="number">2</span>] - <span class="number">1</span>];
    data.bahai.month       = BAHAI_MONTHS[bahcal[<span class="number">3</span>] - <span class="number">1</span>];
    data.bahai.day         = BAHAI_DAYS[bahcal[<span class="number">4</span>] - <span class="number">1</span>];
    data.bahai.weekday     = BAHAI_WEEKDAYS[weekday];
    data.bahai.leap        = <span class="keyword">this</span>.constants.NORM_LEAP[<span class="keyword">this</span>.leap_gregorian(year) ? <span class="number">1</span> : <span class="number">0</span>]; <span class="comment">// Bahai uses same leap rule as Gregorian</span></pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Update Indian Civil Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    indcal = <span class="keyword">this</span>.jd_to_indian_civil(j);

    data.indiancivilcalendar.year    = indcal[<span class="number">0</span>];
    data.indiancivilcalendar.month   = INDIAN_CIVIL_MONTHS[indcal[<span class="number">1</span>] - <span class="number">1</span>];
    data.indiancivilcalendar.day     = indcal[<span class="number">2</span>];
    data.indiancivilcalendar.weekday = INDIAN_CIVIL_WEEKDAYS[weekday];
    data.indiancivilcalendar.leap    = <span class="keyword">this</span>.constants.NORM_LEAP[<span class="keyword">this</span>.leap_gregorian(indcal[<span class="number">0</span>] + <span class="number">78</span>) ? <span class="number">1</span> : <span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Update French Republican Calendar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    frrcal = <span class="keyword">this</span>.jd_to_french_revolutionary(j);

    data.french.an     = frrcal[<span class="number">0</span>];
    data.french.mois   = FRENCH_MOIS[frrcal[<span class="number">1</span>] - <span class="number">1</span>];
    data.french.decade = FRENCH_DECADE[frrcal[<span class="number">2</span>] - <span class="number">1</span>];
    data.french.jour   = FRENCH_JOUR[((frrcal[<span class="number">1</span>] &lt;= <span class="number">12</span>) ? frrcal[<span class="number">3</span>] : (frrcal[<span class="number">3</span>] + <span class="number">11</span>)) - <span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Update Gregorian serial number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (data.gregserial != <span class="literal">null</span>) {
      data.gregserial.day = j - <span class="keyword">this</span>.constants.J0000;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Update Excel 1900 and 1904 day serial numbers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    data.excelserial1900.day = (j - <span class="keyword">this</span>.constants.J1900) + <span class="number">1</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Microsoft marching morons thought 1900 was a leap year.
Adjust dates after 1900-02-28 to compensate for their
idiocy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ((j &gt; <span class="number">2415078.5</span>) ? <span class="number">1</span> : <span class="number">0</span>);
    data.excelserial1904.day = j - <span class="keyword">this</span>.constants.J1904;</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Update Unix time()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    utime = (j - <span class="keyword">this</span>.constants.J1970) * (<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">1000</span>);

    data.unixtime.time = Math.round(utime / <span class="number">1000</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Update ISO Week</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    isoweek = <span class="keyword">this</span>.jd_to_iso(j);

    data.isoweek.year = isoweek[<span class="number">0</span>];
    data.isoweek.week = isoweek[<span class="number">1</span>];
    data.isoweek.day  = isoweek[<span class="number">2</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Update ISO Day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    isoday = <span class="keyword">this</span>.jd_to_iso_day(j);

    data.isoday.year = isoday[<span class="number">0</span>];
    data.isoday.day  = isoday[<span class="number">1</span>];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Preset the fields in
the request form to today&#39;s date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.setDateToToday = <span class="keyword">function</span>() {
    <span class="keyword">var</span> today = <span class="keyword">new</span> Date();

    data.gregorian.year  = today.getFullYear();
    data.gregorian.month = today.getMonth();
    data.gregorian.day   = today.getDate();
    data.gregorian.hour  = <span class="number">0</span>;
    data.gregorian.min   = <span class="number">0</span>;
    data.gregorian.sec   = <span class="number">0</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Preset the fields in
the request form to the time passed in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.setDateTo = <span class="keyword">function</span>(date) {
    data.gregorian.year  = date.getFullYear();
    data.gregorian.month = date.getMonth();
    data.gregorian.day   = date.getDate();
    data.gregorian.hour  = date.getHours();
    data.gregorian.min   = date.getMinutes();
    data.gregorian.sec   = date.getSeconds();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Preset the fields in
the request form to the time now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.setDateToNow = <span class="keyword">function</span>() {
    <span class="keyword">var</span> today = <span class="keyword">new</span> Date();

    <span class="keyword">this</span>.setDateTo(today);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Preset the Gregorian date to the
date requested by the URL
search field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calendar.presetDataToRequest = <span class="keyword">function</span>(s) {
    <span class="keyword">var</span> eq = s.indexOf(<span class="string">"="</span>);
    <span class="keyword">var</span> set = <span class="literal">false</span>;
    <span class="keyword">if</span> (eq != -<span class="number">1</span>) {
      <span class="keyword">var</span> calendar = s.substring(<span class="number">0</span>, eq),
        date = decodeURIComponent(s.substring(eq + <span class="number">1</span>));
      <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"gregorian"</span>) {
        <span class="keyword">var</span> d = date.match(<span class="regexp">/^(\d+)\D(\d+)\D(\d+)(\D\d+)?(\D\d+)?(\D\d+)?/</span>);
        <span class="keyword">if</span> (d != <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Sanity check date and time components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> ((d[<span class="number">2</span>] &gt;= <span class="number">1</span>) &amp;&amp; (d[<span class="number">2</span>] &lt;= <span class="number">12</span>) &amp;&amp;
            (d[<span class="number">3</span>] &gt;= <span class="number">1</span>) &amp;&amp; (d[<span class="number">3</span>] &lt;= <span class="number">31</span>) &amp;&amp;
            ((d[<span class="number">4</span>] == <span class="literal">undefined</span>) ||
              ((d[<span class="number">4</span>].substring(<span class="number">1</span>) &gt;= <span class="number">0</span>) &amp;&amp; (d[<span class="number">4</span>].substring(<span class="number">1</span>) &lt;= <span class="number">23</span>))) &amp;&amp;
            ((d[<span class="number">5</span>] == <span class="literal">undefined</span>) ||
              ((d[<span class="number">5</span>].substring(<span class="number">1</span>) &gt;= <span class="number">0</span>) &amp;&amp; (d[<span class="number">5</span>].substring(<span class="number">1</span>) &lt;= <span class="number">59</span>))) &amp;&amp;
            ((d[<span class="number">6</span>] == <span class="literal">undefined</span>) ||
              ((d[<span class="number">6</span>].substring(<span class="number">1</span>) &gt;= <span class="number">0</span>) &amp;&amp; (d[<span class="number">6</span>].substring(<span class="number">1</span>) &lt;= <span class="number">59</span>)))) {
            data.gregorian.year  = d[<span class="number">1</span>];
            data.gregorian.month = d[<span class="number">2</span>] - <span class="number">1</span>;
            data.gregorian.day   = Number(d[<span class="number">3</span>]);
            data.gregorian.hour  = d[<span class="number">4</span>] == <span class="literal">undefined</span> ? <span class="number">0</span> :
              d[<span class="number">4</span>].substring(<span class="number">1</span>);
            data.gregorian.min = d[<span class="number">5</span>] == <span class="literal">undefined</span> ? <span class="number">0</span> :
              d[<span class="number">5</span>].substring(<span class="number">1</span>);
            data.gregorian.sec = d[<span class="number">6</span>] == <span class="literal">undefined</span> ? <span class="number">0</span> :
              d[<span class="number">6</span>].substring(<span class="number">1</span>);
            <span class="keyword">this</span>.calcGregorian();
            set = <span class="literal">true</span>;
          } <span class="keyword">else</span> {
            alert(<span class="string">"Invalid Gregorian date \""</span> + date +
              <span class="string">"\" in search request"</span>);
          }
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid Gregorian date \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"julian"</span>) {
        <span class="keyword">var</span> d = date.match(<span class="regexp">/^(\d+)\D(\d+)\D(\d+)(\D\d+)?(\D\d+)?(\D\d+)?/</span>);
        <span class="keyword">if</span> (d != <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Sanity check date and time components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> ((d[<span class="number">2</span>] &gt;= <span class="number">1</span>) &amp;&amp; (d[<span class="number">2</span>] &lt;= <span class="number">12</span>) &amp;&amp;
            (d[<span class="number">3</span>] &gt;= <span class="number">1</span>) &amp;&amp; (d[<span class="number">3</span>] &lt;= <span class="number">31</span>) &amp;&amp;
            ((d[<span class="number">4</span>] == <span class="literal">undefined</span>) ||
              ((d[<span class="number">4</span>].substring(<span class="number">1</span>) &gt;= <span class="number">0</span>) &amp;&amp; (d[<span class="number">4</span>].substring(<span class="number">1</span>) &lt;= <span class="number">23</span>))) &amp;&amp;
            ((d[<span class="number">5</span>] == <span class="literal">undefined</span>) ||
              ((d[<span class="number">5</span>].substring(<span class="number">1</span>) &gt;= <span class="number">0</span>) &amp;&amp; (d[<span class="number">5</span>].substring(<span class="number">1</span>) &lt;= <span class="number">59</span>))) &amp;&amp;
            ((d[<span class="number">6</span>] == <span class="literal">undefined</span>) ||
              ((d[<span class="number">6</span>].substring(<span class="number">1</span>) &gt;= <span class="number">0</span>) &amp;&amp; (d[<span class="number">6</span>].substring(<span class="number">1</span>) &lt;= <span class="number">59</span>)))) {
            data.juliancalendar.year = d[<span class="number">1</span>];
            data.juliancalendar.month.selectedIndex = d[<span class="number">2</span>] - <span class="number">1</span>;
            data.juliancalendar.day = Number(d[<span class="number">3</span>]);
            <span class="keyword">this</span>.calcJulianCalendar();
            data.gregorian.hour = d[<span class="number">4</span>] == <span class="literal">undefined</span> ? <span class="number">0</span> :
              d[<span class="number">4</span>].substring(<span class="number">1</span>);
            data.gregorian.min = d[<span class="number">5</span>] == <span class="literal">undefined</span> ? <span class="number">0</span> :
              d[<span class="number">5</span>].substring(<span class="number">1</span>);
            data.gregorian.sec = d[<span class="number">6</span>] == <span class="literal">undefined</span> ? <span class="number">0</span> :
              d[<span class="number">6</span>].substring(<span class="number">1</span>);
            set = <span class="literal">true</span>;
          } <span class="keyword">else</span> {
            alert(<span class="string">"Invalid Julian calendar date \""</span> + date +
              <span class="string">"\" in search request"</span>);
          }
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid Julian calendar date \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"jd"</span>) {
        <span class="keyword">var</span> d = date.match(<span class="regexp">/^(\-?\d+\.?\d*)/</span>);
        <span class="keyword">if</span> (d != <span class="literal">null</span>) {
          <span class="keyword">this</span>.setJulian(d[<span class="number">1</span>]);
          set = <span class="number">1</span>;
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid Julian day \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"mjd"</span>) {
        <span class="keyword">var</span> d = date.match(<span class="regexp">/^(\-?\d+\.?\d*)/</span>);
        <span class="keyword">if</span> (d != <span class="literal">null</span>) {
          data.modifiedjulianday.day = d[<span class="number">1</span>];
          <span class="keyword">this</span>.calcModifiedJulian();
          set = <span class="number">1</span>;
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid Modified Julian day \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"unixtime"</span>) {
        <span class="keyword">var</span> d = date.match(<span class="regexp">/^(\-?\d+\.?\d*)/</span>);
        <span class="keyword">if</span> (d != <span class="literal">null</span>) {
          data.unixtime.time = d[<span class="number">1</span>];
          <span class="keyword">this</span>.calcUnixTime();
          set = <span class="number">1</span>;
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid Modified Julian day \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"iso"</span>) {
        <span class="keyword">var</span> d;
        <span class="keyword">if</span> ((d = date.match(<span class="regexp">/^(\-?\d+)\-(\d\d\d)/</span>)) != <span class="literal">null</span>) {
          data.isoday.year = d[<span class="number">1</span>];
          data.isoday.day = d[<span class="number">2</span>];
          <span class="keyword">this</span>.calcIsoDay();
          set = <span class="number">1</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> ((d = date.match(<span class="regexp">/^(\-?\d+)\-?W(\d\d)\-?(\d)/i</span>)) != <span class="literal">null</span>) {
          data.isoweek.year = d[<span class="number">1</span>];
          data.isoweek.week = d[<span class="number">2</span>];
          data.isoweek.day = d[<span class="number">3</span>];
          <span class="keyword">this</span>.calcIsoWeek();
          set = <span class="number">1</span>;
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid ISO-8601 date \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"excel"</span>) {
        <span class="keyword">var</span> d = date.match(<span class="regexp">/^(\-?\d+\.?\d*)/</span>);
        <span class="keyword">if</span> (d != <span class="literal">null</span>) {
          data.excelserial1900.day = d[<span class="number">1</span>];
          <span class="keyword">this</span>.calcExcelSerial1900();
          set = <span class="number">1</span>;
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid Excel serial day (1900/PC) \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> <span class="keyword">if</span> (calendar.toLowerCase() == <span class="string">"excel1904"</span>) {
        <span class="keyword">var</span> d = date.match(<span class="regexp">/^(\-?\d+\.?\d*)/</span>);
        <span class="keyword">if</span> (d != <span class="literal">null</span>) {
          data.excelserial1904.day = d[<span class="number">1</span>];
          <span class="keyword">this</span>.calcExcelSerial1904();
          set = <span class="number">1</span>;
        } <span class="keyword">else</span> {
          alert(<span class="string">"Invalid Excel serial day (1904/Mac) \""</span> + date +
            <span class="string">"\" in search request"</span>);
        }

      } <span class="keyword">else</span> {
        alert(<span class="string">"Invalid calendar \""</span> + calendar +
          <span class="string">"\" in search request"</span>);
      }
    } <span class="keyword">else</span> {
      alert(<span class="string">"Invalid search request: "</span> + s);
    }

    <span class="keyword">if</span> (!set) {
      <span class="keyword">this</span>.setDateToToday();
      <span class="keyword">this</span>.calcGregorian();
    }
  }

  <span class="keyword">return</span> exports;
}(Ephemerides || {}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
